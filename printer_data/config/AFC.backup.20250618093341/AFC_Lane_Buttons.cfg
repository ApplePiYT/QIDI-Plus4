################## THIS IS THE BUTTONS MACROS ###################
################## MAKE SURE TO SET YOUR PINS! ##################


########################## LANE 1 #################################

[gcode_button Lane_1]
pin: Turtle_1:RGB2                      
#analog_range:400,550
#analog_pullup_resistor: 470

press_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      SET_GCODE_VARIABLE MACRO=Lane_1 VARIABLE=last_press VALUE={current_timer}
      {action_respond_info("Button pressed. Time recorded: %.2f seconds" % (current_timer))}
  {% endif %}

release_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}
      {action_respond_info("Safety check: Cannot perform action while printing.")}
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      # Calculate the press duration
      {% set last_press = printer["gcode_macro Lane_1"].last_press|float %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      {% set duration = current_timer - last_press %}
      {action_respond_info("Button released. Press duration: %.2f seconds" % (duration))}
  
      # Retrieve the current lane state for additional actions (if necessary)
      {% set current_lane = printer.AFC.system.current_load %}
      {action_respond_info("Current lane: %s" % current_lane)}

      # Handle actions based on press duration
      {% if duration > 1.2 %}
          # Long press: Unload tool and eject lane 1
          {action_respond_info("Long press detected. Checking lane state before unloading tool.")}

          # Unload 'leg1' if it's the currently loaded lane
          {% if current_lane == "leg1" %}
              {action_respond_info("Unloading leg1 before ejecting lane 1.")}
              BT_TOOL_UNLOAD
              G4 P500  # Pause for 500 ms to allow tool unload to complete
          {% else %}
              {action_respond_info("No need to unload. Other lane is loaded.")}
          {% endif %}
          
          # Eject lane 1
          {action_respond_info("Ejecting lane 1.")}
          BT_LANE_EJECT LANE=1
      {% elif duration < 1.2 %}
          # Short press: Load or unload lane 1
          {% if current_lane == "leg1" %}
              {action_respond_info("Short press detected. Lane 1 is loaded. Unloading tool.")}
              BT_TOOL_UNLOAD
          {% else %}
              {action_respond_info("Short press detected. Loading tool to lane 1.")}
              BT_CHANGE_TOOL LANE=1
          {% endif %}
      {% else %}
          {action_respond_info("Press duration too short. No action performed.")}
      {% endif %}
  {% endif %}

[gcode_macro Lane_1]
variable_last_press: 0.0
gcode:

########################## LANE 2 #################################

[gcode_button Lane_2]
pin: !Turtle_1:RGB3
#analog_pullup_resistor: 470

press_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}      
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      SET_GCODE_VARIABLE MACRO=Lane_2 VARIABLE=last_press VALUE={current_timer}
      {action_respond_info("Button pressed. Time recorded: %.2f seconds" % (current_timer))}
  {% endif %}

release_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}
      {action_respond_info("Safety check: Cannot perform action while printing.")}
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      # Calculate the press duration
      {% set last_press = printer["gcode_macro Lane_2"].last_press|float %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      {% set duration = current_timer - last_press %}
      {action_respond_info("Button released. Press duration: %.2f seconds" % (duration))}
  
      # Retrieve the current lane state for additional actions (if necessary)
      {% set current_lane = printer.AFC.system.current_load %}
      {action_respond_info("Current lane: %s" % current_lane)}

      # Handle actions based on press duration
      {% if duration > 1.2 %}
          # Long press: Unload tool and eject lane 2
          {action_respond_info("Long press detected. Checking lane state before unloading tool.")}

          # Unload 'leg2' if it's the currently loaded lane
          {% if current_lane == "leg2" %}
              {action_respond_info("Unloading leg2 before ejecting lane 2.")}
              BT_TOOL_UNLOAD
              G4 P500  # Pause for 500 ms to allow tool unload to complete
          {% else %}
              {action_respond_info("No need to unload. Other lane is loaded.")}
          {% endif %}
          
          # Eject lane 2
          {action_respond_info("Ejecting lane 2.")}
          BT_LANE_EJECT LANE=2
      {% elif duration < 1.2 %}
          # Short press: Load or unload lane 2
          {% if current_lane == "leg2" %}
              {action_respond_info("Short press detected. Lane 2 is loaded. Unloading tool.")}
              BT_TOOL_UNLOAD
          {% else %}
              {action_respond_info("Short press detected. Loading tool to lane 2.")}
              BT_CHANGE_TOOL LANE=2
          {% endif %}
      {% else %}
          {action_respond_info("Press duration too short. No action performed.")}
      {% endif %}
  {% endif %}

[gcode_macro Lane_2]
variable_last_press: 0.0
gcode:

########################## LANE 3 #################################

[gcode_button Lane_3]
pin: !Turtle_1:RGB4
#analog_pullup_resistor: 470

press_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}     
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      SET_GCODE_VARIABLE MACRO=Lane_3 VARIABLE=last_press VALUE={current_timer}
      {action_respond_info("Button pressed. Time recorded: %.2f seconds" % (current_timer))}
  {% endif %}

release_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}
      {action_respond_info("Safety check: Cannot perform action while printing.")}
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      # Calculate the press duration
      {% set last_press = printer["gcode_macro Lane_3"].last_press|float %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      {% set duration = current_timer - last_press %}
      {action_respond_info("Button released. Press duration: %.2f seconds" % (duration))}
  
      # Retrieve the current lane state for additional actions (if necessary)
      {% set current_lane = printer.AFC.system.current_load %}
      {action_respond_info("Current lane: %s" % current_lane)}

      # Handle actions based on press duration
      {% if duration > 1.2 %}
          # Long press: Unload tool and eject lane 3
          {action_respond_info("Long press detected. Checking lane state before unloading tool.")}

          # Unload 'leg3' if it's the currently loaded lane
          {% if current_lane == "leg3" %}
              {action_respond_info("Unloading leg3 before ejecting lane 3.")}
              BT_TOOL_UNLOAD
              G4 P500  # Pause for 500 ms to allow tool unload to complete
          {% else %}
              {action_respond_info("No need to unload. Other lane is loaded.")}
          {% endif %}
          
          # Eject lane 3
          {action_respond_info("Ejecting lane 3.")}
          BT_LANE_EJECT LANE=3
      {% elif duration < 1.2 %}
          # Short press: Load or unload lane 3
          {% if current_lane == "leg3" %}
              {action_respond_info("Short press detected. Lane 3 is loaded. Unloading tool.")}
              BT_TOOL_UNLOAD
          {% else %}
              {action_respond_info("Short press detected. Loading tool to lane 3.")}
              BT_CHANGE_TOOL LANE=3
          {% endif %}
      {% else %}
          {action_respond_info("Press duration too short. No action performed.")}
      {% endif %}
  {% endif %}

[gcode_macro Lane_3]
variable_last_press: 0.0
gcode:

########################## LANE 4 #################################

[gcode_button Lane_4]
pin: ^!Turtle_1:SW6

press_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}    
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      SET_GCODE_VARIABLE MACRO=Lane_4 VARIABLE=last_press VALUE={current_timer}
      {action_respond_info("Button pressed. Time recorded: %.2f seconds" % (current_timer))}
  {% endif %}

release_gcode:
  # Safety check if the printer is actively printing
  {% if printer.print_stats.state == 'printing' %}
      {action_respond_info("Safety check: Cannot perform action while printing.")}
      # Simply return from the macro by not running further code
      {% set cancel = True %}
  {% else %}
      {% set cancel = False %}
  {% endif %}
  
  {% if not cancel %}
      # Calculate the press duration
      {% set last_press = printer["gcode_macro Lane_4"].last_press|float %}
      {% set current_timer = printer.toolhead.estimated_print_time %}
      {% set duration = current_timer - last_press %}
      {action_respond_info("Button released. Press duration: %.2f seconds" % (duration))}
  
      # Retrieve the current lane state for additional actions (if necessary)
      {% set current_lane = printer.AFC.system.current_load %}
      {action_respond_info("Current lane: %s" % current_lane)}

      # Handle actions based on press duration
      {% if duration > 1.2 %}
          # Long press: Unload tool and eject lane 4
          {action_respond_info("Long press detected. Checking lane state before unloading tool.")}

          # Unload 'leg4' if it's the currently loaded lane
          {% if current_lane == "leg4" %}
              {action_respond_info("Unloading leg4 before ejecting lane 4.")}
              BT_TOOL_UNLOAD
              G4 P500  # Pause for 500 ms to allow tool unload to complete
          {% else %}
              {action_respond_info("No need to unload. Other lane is loaded.")}
          {% endif %}
          
          # Eject lane 4
          {action_respond_info("Ejecting lane 4.")}
          BT_LANE_EJECT LANE=4
      {% elif duration < 1.2 %}
          # Short press: Load or unload lane 4
          {% if current_lane == "leg4" %}
              {action_respond_info("Short press detected. Lane 4 is loaded. Unloading tool.")}
              BT_TOOL_UNLOAD
          {% else %}
              {action_respond_info("Short press detected. Loading tool to lane 4.")}
              BT_CHANGE_TOOL LANE=4
          {% endif %}
      {% else %}
          {action_respond_info("Press duration too short. No action performed.")}
      {% endif %}
  {% endif %}

[gcode_macro Lane_4]
variable_last_press: 0.0
gcode:

